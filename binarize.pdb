#!/bin/bash
# pbs launching script example for NAMD job
# PLEASE DO NOT CHANGE THIS FILE. TO SUBMIT QUEUE, PLS MAKE A COPY OF THIS FILE AND MAKE THE ACCORDING CHANGES

#     job name:
#PBS -N FishHead 
#PBS -P RDS-FEI-NRMMCI-RW
#PBS -q compute 

#     how many cpus?
#PBS -l ncpus=16
#PBS -l nodes=1
#PBS -M lsqshr@gmail.com 

#PBS -l pmem=16gb

# How long to run the job? (hours:minutes:seconds)
#PBS -l walltime=3:00:0
#PBS -m ae
#     Name of output file:
#PBS -o binarize.txt

#     Environmental varibles to make it work:
 
module load matlab;
cd $PBS_O_WORKDIR;

#     Launching the job!
JOBNAME='CollectVesselness';

DATETIME=$(date +"%F-%T");

#     Transfer the trained model to data folder
cachefolder=/project/RDS-FEI-NRMMCI-RW/NeuvealCache/$JOBNAME$DATETIME;

if [ ! -d "$cachefolder" ];then
	echo "Creating cache job folder: $cachefolder";
	mkdir $cachefolder;
else
	echo "Cache job folder exists: $cachefolder";
fi

# me="$(basename "$(test -L "$0" && readlink "$0" || echo "$0")")"
# cp $PBS_O_WORKDIR/vess.pbs $cachefolder/vess.pbs;

DATAPATH=/project/RDS-FEI-NRMMCI-RW/Data/first2000/first2000-subsets/first5/00001.FruMARCM-M002262_seg001.lsm.tif.c3.v3draw.uint8.v3draw;
TARGET=/project/RDS-FEI-NRMMCI-RW/Data/first2000/first2000-subsets/first5/00001.FruMARCM-M002262_seg001.lsm.tif.c3.v3draw.uint8.v3draw.binary.mat;
MODELPATH=/project/RDS-FEI-NRMMCI-RW/Data/OP/quad.mat;

# arr=( $(find $DATAPATH -name '*.mat') );
# filename=${arr[${PBS_ARRAY_INDEX}]};

#     Run Script
matlab -nodesktop -nosplash -r "cd util; load('$MODELPATH'); tic; [X, feats] = binarizeimage('$DATAPATH', obj, 2); toc; save('$TARGET', 'X', 'feats');";
